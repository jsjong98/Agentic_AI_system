# GPU ì§€ì› PyTorch ë² ì´ìŠ¤ ì´ë¯¸ì§€
FROM pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime

# ë¹„ëŒ€í™”í˜• ì„¤ì¹˜ + íƒ€ìž„ì¡´ ì„¤ì •
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Seoul

WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± (tzdata + distutils + dev í—¤ë”)
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      tzdata \
      build-essential \
      libopenblas-dev \
      libglib2.0-0 \
      libsm6 \
      libxext6 \
      libxrender-dev \
      python3-distutils \
      python3-dev \
      curl \
      wget \
      chromium-browser \
      chromium-chromedriver \
 && ln -fs /usr/share/zoneinfo/$TZ /etc/localtime \
 && echo $TZ > /etc/timezone \
 && dpkg-reconfigure -f noninteractive tzdata \
 && rm -rf /var/lib/apt/lists/*

# Chrome/Chromium í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Seleniumìš©)
ENV CHROME_BIN=/usr/bin/chromium-browser
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver

# 1) pip/setuptools/wheel ìµœì‹ í™”
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# 2) requirements íŒŒì¼ ë¨¼ì € ë³µì‚¬ (ìºì‹œ í™œìš©)
COPY requirements-docker.txt .

# 3) ì£¼ìš” ê³¼í•™ ìŠ¤íƒì„ condaë¡œ ì„¤ì¹˜ (C-API ë²„ì „ ì¶©ëŒ ë°©ì§€)
RUN conda install -y \
      numpy=1.24.3 \
      pandas=2.1.1 \
      scikit-learn=1.3.0 \
      matplotlib=3.7.2 \
      seaborn=0.12.2 \
      python-dateutil=2.8.2 \
      pytz=2023.3 \
 && conda clean -afy

# 4) Docker ì „ìš© requirementsë¡œ ë‚˜ë¨¸ì§€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì¤‘ë³µ ì œì™¸)
RUN pip install --no-cache-dir -r requirements-docker.txt

# 5) ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬ (ì½”ë“œ ë³€ê²½ ì‹œì—ë§Œ ìž¬ë¹Œë“œ)
COPY . .

# ë¡œê·¸Â·ëª¨ë¸Â·ì—…ë¡œë“œÂ·ê²°ê³¼ í´ë” ë¯¸ë¦¬ ìƒì„± (ëª¨ë“  ì—ì´ì „íŠ¸ìš©)
RUN mkdir -p \
    logs \
    models \
    uploads \
    cache \
    results \
    temp \
    data \
    static/plots \
    static/reports \
    static/ma_plots \
    static/attention \
    predictions \
    holidays \
    Structura/models \
    Cognita/cache \
    Chronos/models \
    Sentio/cache \
    Agora/data \
    Supervisor/logs \
    Integration/results

# ëª¨ë“  ì—ì´ì „íŠ¸ í¬íŠ¸ ë…¸ì¶œ
EXPOSE 5001 5002 5003 5004 5005 5006 5007

# netcat ì„¤ì¹˜ (í—¬ìŠ¤ì²´í¬ìš©)
RUN apt-get update && apt-get install -y --no-install-recommends netcat-openbsd && rm -rf /var/lib/apt/lists/*

# í†µí•© ì„œë¹„ìŠ¤ ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Agentic AI System - Docker ì»¨í…Œì´ë„ˆ ì‹œìž‘"\n\
echo "==============================================="\n\
\n\
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •\n\
export PYTHONIOENCODING=utf-8\n\
export PYTHONUNBUFFERED=1\n\
\n\
# í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ëª¨ë“  ìžì‹ í”„ë¡œì„¸ìŠ¤ë„ ì¢…ë£Œ\n\
trap "echo \"âš ï¸  Shutting down all agents...\"; kill 0" EXIT SIGTERM SIGINT\n\
\n\
# ê° ì—ì´ì „íŠ¸ë¥¼ ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹œìž‘\n\
echo "ðŸ¤– Starting Structura Agent (Port 5001)..."\n\
cd /app/Structura && python run_structura_server.py &\n\
PID_STRUCTURA=$!\n\
\n\
echo "ðŸ§  Starting Cognita Agent (Port 5002)..."\n\
cd /app/Cognita && python run_cognita_server.py &\n\
PID_COGNITA=$!\n\
\n\
echo "â° Starting Chronos Agent (Port 5003)..."\n\
cd /app/Chronos && python run_chronos_server.py &\n\
PID_CHRONOS=$!\n\
\n\
echo "ðŸ’­ Starting Sentio Agent (Port 5004)..."\n\
cd /app/Sentio && python run_sentio_server.py &\n\
PID_SENTIO=$!\n\
\n\
echo "ðŸ›ï¸ Starting Agora Agent (Port 5005)..."\n\
cd /app/Agora && python run_agora_server.py &\n\
PID_AGORA=$!\n\
\n\
echo "ðŸ‘‘ Starting Supervisor Agent (Port 5006)..."\n\
cd /app/Supervisor && python run_supervisor_server.py &\n\
PID_SUPERVISOR=$!\n\
\n\
echo "ðŸ”— Starting Integration Agent (Port 5007)..."\n\
cd /app/Integration && python run_integration_server.py &\n\
PID_INTEGRATION=$!\n\
\n\
echo ""\n\
echo "â³ Waiting for all services to be ready..."\n\
\n\
# ê° í¬íŠ¸ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)\n\
for port in 5001 5002 5003 5004 5005 5006 5007; do\n\
  echo -n "   Checking port $port... "\n\
  timeout=60\n\
  while ! nc -z localhost $port 2>/dev/null; do\n\
    sleep 1\n\
    timeout=$((timeout - 1))\n\
    if [ $timeout -le 0 ]; then\n\
      echo "âŒ Timeout"\n\
      echo "âš ï¸  Warning: Port $port did not respond in time"\n\
      break\n\
    fi\n\
  done\n\
  [ $timeout -gt 0 ] && echo "âœ…"\n\
done\n\
\n\
echo ""\n\
echo "âœ… All agents started successfully!"\n\
echo "==============================================="\n\
echo "ðŸ“¡ Available Services:"\n\
echo "  â€¢ Structura    â†’ http://localhost:5001 (PID: $PID_STRUCTURA)"\n\
echo "  â€¢ Cognita      â†’ http://localhost:5002 (PID: $PID_COGNITA)"\n\
echo "  â€¢ Chronos      â†’ http://localhost:5003 (PID: $PID_CHRONOS)"\n\
echo "  â€¢ Sentio       â†’ http://localhost:5004 (PID: $PID_SENTIO)"\n\
echo "  â€¢ Agora        â†’ http://localhost:5005 (PID: $PID_AGORA)"\n\
echo "  â€¢ Supervisor   â†’ http://localhost:5006 (PID: $PID_SUPERVISOR)"\n\
echo "  â€¢ Integration  â†’ http://localhost:5007 (PID: $PID_INTEGRATION)"\n\
echo "==============================================="\n\
\n\
# ëª¨ë“  ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°\n\
wait\n\
' > /app/start_all_agents.sh && chmod +x /app/start_all_agents.sh

CMD ["/app/start_all_agents.sh"]
